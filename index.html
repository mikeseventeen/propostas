<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Propostas Viewer</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootswatch Theme -->
    <link href="https://cdn.jsdelivr.net/npm/bootswatch@5.3.0/dist/lumen/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            margin: 20px;
        }
        .popup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            border: 1px solid #ccc;
            padding: 20px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            max-width: 90%;
            width: 600px;
            max-height: 80%;
            overflow-y: auto;
        }
        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="my-4">Fuck DEI!</h1>
        <input type="file" id="fileInput" accept="application/json" class="form-control mb-4">

        <a href="estudante.html" class="btn btn-primary mb-4">Por Estudante</a>


        <table id="propostasTable" class="table table-striped">
            <thead>
                <tr>
                    <th>Data Submissão</th>
                    <th>Organização</th>
                    <th>Título</th>
                    <th>Problema</th>
                    <th>Objetivos</th>
                    <th>Ações</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <div class="overlay" id="overlay"></div>
    <div class="popup" id="popup">
        <h4>Candidaturas</h4>
        <div id="popupTotal" class="fw-bold mb-2">Total de Candidaturas: 0</div>
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Nome Completo</th>
                    <th>Email</th>
                    <th>Estado Candidatura</th>
                    <th>Data</th>
                </tr>
            </thead>
            <tbody id="candidaturasContent"></tbody>
        </table>
        <button class="btn btn-primary" onclick="closePopup()">Fechar</button>
    </div>

    <script>
        const fileInput = document.getElementById('fileInput');
        const propostasTable = document.querySelector('#propostasTable tbody');
        const popup = document.getElementById('popup');
        const overlay = document.getElementById('overlay');
        const candidaturasContent = document.getElementById('candidaturasContent');
        const totalCandidaturasElement = document.getElementById('totalCandidaturas');
        const popupTotal = document.getElementById('popupTotal');
    
        let totalCandidaturas = 0;
        let propostasData = []; // Store the loaded JSON data here
    
        window.onload = function () {
            // Fetch "propostas.json" on window load
            fetch('propostas.json')
                .then((response) => {
                    if (!response.ok) {
                        throw new Error('Failed to load propostas.json');
                    }
                    return response.json();
                })
                .then((json) => {
                    propostasData = json; // Save the data globally
                    displayPropostas(propostasData);
                })
                .catch((error) => {
                    console.error('Error loading propostas.json:', error);
                });
        };
    
        fileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    propostasData = JSON.parse(e.target.result);
                    displayPropostas(propostasData);
                };
                reader.readAsText(file);
            }
        });
    
        function displayPropostas(propostas) {
            propostasTable.innerHTML = '';
            totalCandidaturas = 0;
    
            propostas.forEach((proposta, index) => {
                const row = document.createElement('tr');
                const candidaturas = proposta.candidaturas || [];
                totalCandidaturas += candidaturas.length;
    
                row.innerHTML = `
                    <td>${new Date(proposta.submissao.data_submissao).toLocaleString('pt-PT')}</td>
                    <td>${proposta.submissao.proponente.organizacao}</td>
                    <td>${proposta.submissao.titulo}</td>
                    <td>${proposta.submissao.problema}</td>
                    <td>${proposta.submissao.objetivos.replace(/\n/g, '<br>')}</td>
                    <td><button class="btn btn-primary btn-sm" onclick="showCandidaturas(${index})">Ver Candidaturas</button></td>
                `;
                propostasTable.appendChild(row);
            });
    
            totalCandidaturasElement.textContent = `Total de Candidaturas: ${totalCandidaturas}`;
        }
    
        function showCandidaturas(index) {
            const candidaturas = propostasData[index]?.candidaturas || [];
            popupTotal.textContent = `Total de Candidaturas: ${candidaturas.length}`;
    
            candidaturasContent.innerHTML = '';
            if (candidaturas.length === 0) {
                candidaturasContent.innerHTML = '<tr><td colspan="4">Nenhuma candidatura disponível.</td></tr>';
            } else {
                candidaturas.forEach((candidatura) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${candidatura.estudante.nome} ${candidatura.estudante.sobrenome}</td>
                        <td>${candidatura.estudante.email}</td>
                        <td style="color: ${getStatusColor(candidatura.estado)}; font-weight: bold;">
                            ${candidatura.estado}
                        </td>
                        <td>${candidatura.candidatura.data_candidatura ? new Date(candidatura.candidatura.data_candidatura).toLocaleDateString('pt-PT') : 'Não candidatou'}</td>
                    `;
                    candidaturasContent.appendChild(row);
                });
            }
    
            popup.style.display = 'block';
            overlay.style.display = 'block';
        }
    
        function getStatusColor(status) {
            switch (status) {
                case 'Candidatada':
                    return 'green';
                case 'Selecionada':
                    return 'purple';
                case 'Retirada':
                    return 'red';
                case 'Aceite':
                    return 'magenta';
                default:
                    return 'black';
            }
        }
    
        function closePopup() {
            popup.style.display = 'none';
            overlay.style.display = 'none';
        }
    </script>
    
</body>
</html>
